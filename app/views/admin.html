{% extends "base.html" %}
{% block content %}
<h2>System Administration</h2>

<div class="admin-section">
  <h3>Preset Tags Management</h3>
  <p>Configure preset tags for faster ticket categorization.</p>
  
  <div class="tags-preview">
    <h4>Current Tags:</h4>
    <div id="current-tags">
      {% for tag in admin.preset_tags %}
      <div class="tag-item" data-value="{{ tag.value }}">
        <span class="tag-preview" style="background-color: {{ tag.color }}20; border: 1px solid {{ tag.color }}; color: {{ tag.color }};">{{ tag.label }}</span>
        <button class="edit-tag-btn" onclick="editTag('{{ tag.value }}', '{{ tag.label }}', '{{ tag.color }}')">Edit</button>
        <button class="delete-tag-btn" onclick="deleteTag('{{ tag.value }}')">Delete</button>
      </div>
      {% endfor %}
    </div>
  </div>
  
  <div class="tag-form">
    <h4>Add/Edit Tag:</h4>
    <form id="tag-form">
      <input type="hidden" id="edit-tag-original-value" value="">
      <div class="form-row">
        <label>Label: <input type="text" id="tag-label" placeholder="Work" required></label>
        <label>Value: <input type="text" id="tag-value" placeholder="work" required></label>
        <label>Color: <input type="color" id="tag-color" value="#3b82f6" required></label>
      </div>
      <div class="form-buttons">
        <button type="submit" id="save-tag-btn">Add Tag</button>
        <button type="button" onclick="cancelTagEdit()">Cancel</button>
      </div>
    </form>
  </div>
</div>

<div class="admin-section">
  <h3>Print Configuration</h3>
  <p><strong>Backend:</strong> {{ admin.print_backend }}</p>
  {% if admin.connection_info %}
  <p><strong>Connection:</strong> {{ admin.connection_info }}</p>
  {% endif %}
</div>

<div class="admin-section">
  <h3>Storage</h3>
  <p><strong>Archive Directory:</strong> {{ admin.archive_dir }}</p>
  <p><strong>Output Directory:</strong> {{ admin.output_dir }}</p>
  
  {% if admin.disk_info %}
  <div class="disk-usage">
    <p><strong>Disk Usage:</strong></p>
    <ul>
      <li>Total: {{ admin.disk_info.total_gb }} GB</li>
      <li>Used: {{ admin.disk_info.used_gb }} GB ({{ admin.disk_info.used_percent }}%)</li>
      <li>Free: {{ admin.disk_info.free_gb }} GB</li>
    </ul>
  </div>
  {% endif %}
</div>

<div class="admin-section">
  <h3>System Health</h3>
  <p><strong>API Status:</strong> <span id="health-status">Checking...</span></p>
  <button onclick="checkHealth()">Refresh Health Check</button>
</div>

<style>
.admin-section {
  margin: 1.5rem 0;
  padding: 1rem;
  border: 1px solid #ddd;
  border-radius: 4px;
}
.disk-usage ul {
  margin: 0.5rem 0;
}
#health-status {
  font-weight: bold;
}
.health-ok { color: green; }
.health-error { color: red; }

/* Tag management styles */
.tags-preview {
  margin: 1rem 0;
}
.tag-item {
  display: flex;
  align-items: center;
  margin: 0.5rem 0;
  padding: 0.5rem;
  background: #f8f9fa;
  border-radius: 4px;
}
.tag-preview {
  padding: 0.3rem 0.6rem;
  border-radius: 0.3rem;
  font-size: 0.85rem;
  margin-right: 1rem;
}
.edit-tag-btn, .delete-tag-btn {
  margin-left: 0.5rem;
  padding: 0.25rem 0.5rem;
  font-size: 0.8rem;
  border: 1px solid #ddd;
  border-radius: 3px;
  cursor: pointer;
}
.edit-tag-btn { background: #e3f2fd; }
.delete-tag-btn { background: #ffebee; }
.tag-form {
  background: #f5f5f5;
  padding: 1rem;
  border-radius: 4px;
  margin-top: 1rem;
}
.form-row {
  display: flex;
  gap: 1rem;
  margin-bottom: 1rem;
}
.form-row label {
  display: flex;
  flex-direction: column;
  flex: 1;
}
.form-row input {
  margin-top: 0.25rem;
  padding: 0.5rem;
}
.form-buttons {
  display: flex;
  gap: 0.5rem;
}
.form-buttons button {
  padding: 0.5rem 1rem;
  border: 1px solid #ddd;
  border-radius: 4px;
  cursor: pointer;
}
.form-buttons button[type="submit"] { background: #4caf50; color: white; }
.form-buttons button[type="button"] { background: #f44336; color: white; }
#message {
  padding: 0.75rem;
  margin: 0.5rem 0;
  border-radius: 4px;
  display: none;
}
.message-success { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
.message-error { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
</style>

<script>
// Health check functionality
function checkHealth() {
  const statusEl = document.getElementById('health-status');
  statusEl.textContent = 'Checking...';
  statusEl.className = '';
  
  fetch('/api/health')
    .then(response => response.json())
    .then(data => {
      if (data.ok) {
        statusEl.textContent = 'OK';
        statusEl.className = 'health-ok';
      } else {
        statusEl.textContent = 'Error';
        statusEl.className = 'health-error';
      }
    })
    .catch(error => {
      statusEl.textContent = 'Failed to connect';
      statusEl.className = 'health-error';
    });
}

// Tag management functionality
let currentTags = {{ admin.preset_tags | tojson | safe }};

function editTag(value, label, color) {
  document.getElementById('edit-tag-original-value').value = value;
  document.getElementById('tag-label').value = label;
  document.getElementById('tag-value').value = value;
  document.getElementById('tag-color').value = color;
  document.getElementById('save-tag-btn').textContent = 'Update Tag';
}

function cancelTagEdit() {
  document.getElementById('tag-form').reset();
  document.getElementById('edit-tag-original-value').value = '';
  document.getElementById('save-tag-btn').textContent = 'Add Tag';
}

function deleteTag(value) {
  if (!confirm(`Are you sure you want to delete the "${value}" tag?`)) return;
  
  fetch(`/api/admin/tags/${value}`, { method: 'DELETE' })
    .then(response => response.json())
    .then(data => {
      if (data.success) {
        showMessage(data.message, 'success');
        setTimeout(() => window.location.reload(), 1000);
      } else {
        showMessage(data.error, 'error');
      }
    })
    .catch(error => {
      showMessage('Network error: ' + error.message, 'error');
    });
}

function showMessage(text, type) {
  let messageEl = document.getElementById('message');
  if (!messageEl) {
    messageEl = document.createElement('div');
    messageEl.id = 'message';
    document.querySelector('.admin-section').insertBefore(messageEl, document.querySelector('.tags-preview'));
  }
  
  messageEl.textContent = text;
  messageEl.className = `message-${type}`;
  messageEl.style.display = 'block';
  
  setTimeout(() => {
    messageEl.style.display = 'none';
  }, 5000);
}

// Handle tag form submission
document.getElementById('tag-form').addEventListener('submit', function(e) {
  e.preventDefault();
  
  const originalValue = document.getElementById('edit-tag-original-value').value;
  const label = document.getElementById('tag-label').value.trim();
  const value = document.getElementById('tag-value').value.trim().toLowerCase();
  const color = document.getElementById('tag-color').value;
  
  if (!label || !value) {
    showMessage('Label and value are required', 'error');
    return;
  }
  
  // Update existing tags array
  let updatedTags = [...currentTags];
  
  if (originalValue) {
    // Edit existing tag
    const index = updatedTags.findIndex(tag => tag.value === originalValue);
    if (index >= 0) {
      updatedTags[index] = { label, value, color };
    }
  } else {
    // Add new tag
    if (updatedTags.some(tag => tag.value === value)) {
      showMessage('Tag with this value already exists', 'error');
      return;
    }
    updatedTags.push({ label, value, color });
  }
  
  // Send to server
  const formData = new FormData();
  formData.append('tags_json', JSON.stringify(updatedTags));
  
  fetch('/api/admin/tags', {
    method: 'POST',
    body: formData
  })
  .then(response => response.json())
  .then(data => {
    if (data.success) {
      showMessage(data.message, 'success');
      setTimeout(() => window.location.reload(), 1000);
    } else {
      showMessage(data.error, 'error');
    }
  })
  .catch(error => {
    showMessage('Network error: ' + error.message, 'error');
  });
});

// Check health on page load
checkHealth();
</script>

{% endblock %}
